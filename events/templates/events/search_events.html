{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Events</title>
    <style>
        .event-card {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .event-card img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
        }

        .error-message {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>Search for Events</h1>

    <form method="GET">
        {{ form.as_p }}
        <button type="submit">Search</button>
    </form>

    {% if error_message %}
    <p class="error-message">{{ error_message }}</p>
    {% endif %}

    {% if events %}
    <h2>Events Found:</h2>
    <div>
        {% for event in events %}
        <!-- Example event card with AJAX-enabled save form -->
        <div class="event-card" id="event-{{ event.id|default:event.name|slugify }}">
            {% if event.image %}
            <img class="event-image" src="{{ event.image }}" alt="{{ event.name }}">
            {% endif %}
            <h3>{{ event.name }}</h3>
            <p><strong>Date:</strong> {{ event.date }}</p>
            <p><strong>Venue:</strong> {{ event.venue }}</p>
            <p><strong>Description:</strong> {{ event.description }}</p>
            <a href="{{ event.url }}" target="_blank">More Info</a>

            {% if user.is_authenticated %}
            <form class="add-event-form" action="{% url 'vacations:add_event_to_vacation' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="event_id" value="{{ event.id }}">
                <input type="hidden" name="name" value="{{ event.name }}">
                <input type="hidden" name="date" value="{{ event.date }}">
                <input type="hidden" name="venue" value="{{ event.venue }}">
                <input type="hidden" name="description" value="{{ event.description }}">
                <input type="hidden" name="image_url" value="{{ event.image }}">
                <input type="hidden" name="event_url" value="{{ event.url }}">
            
                <!-- Vacation Dropdown -->
                {% if vacations %}
                  <label for="vacation">Select a Vacation</label>
                  <select name="vacation" id='vacation' required>
                    {% for vacation in vacations %}
                      <option value="{{ vacation.id }}">{{ vacation.name }}</option>
                    {% endfor %}
                  </select>
                {% else %}
                  <p>No vacations found. Please create one first.</p>
                {% endif %}
            
                <button type="submit">Save to Vacation</button>
            </form>
            <div class="ajax-message" id="message-{{ event.id|default:event.name|slugify }}"></div>
            {% else %}
            <p>Please log in to save events.</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const forms = document.querySelectorAll(".add-event-form"); // Get all event save forms

            forms.forEach((form) => { // Add event listener to each form
                form.addEventListener("submit", function (e) {
                    e.preventDefault();  // Prevent form submission

                    const formData = new FormData(form); // Get form data
                    const actionUrl = form.getAttribute("action"); // Now no fallback is needed

                    // Get CSRF token from the DOM
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    console.log("CSRF Token:", csrfToken);  // Debug log for CSRF token

                    // Debugging form data
                    console.log("Form Data:", formData); // Log the form data to ensure it includes vacation field

                    // Check if vacation field is present in FormData
                    if (!formData.has('vacation')) {
                        console.error("Vacation field is missing in the form data");
                        return; // Stop submission if the vacation field is missing
                    }

                    fetch(actionUrl, { // Send form data via AJAX
                        method: "POST",
                        body: formData,
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "X-CSRFToken": csrfToken,  // Add CSRF token here
                        },
                    })
                        .then((response) => response.json()) // Parse response as JSON
                        .then((data) => {
                            const eventId = form.getAttribute("data-event-id"); // Get event ID
                            const messageDiv = document.getElementById("message-" + eventId); // Get message div

                            console.log("Response Data:", data); // Debug log for response

                            if (data.success) { // Show success or error message
                                if (messageDiv) {
                                    messageDiv.innerHTML = `<p style="color:green;">${data.message}</p>`;
                                    form.querySelector("button[type=submit]").disabled = true; // Prevent multiple saves
                                } else {
                                    console.error("Message div not found for event ID " + eventId);  // Error if message div is missing
                                }
                            } else { // Show error message
                                let errorText = data.errors
                                    ? Object.values(data.errors).join("<br>")
                                    : "An error occurred";
                                if (messageDiv) {
                                    messageDiv.innerHTML = `<p style="color:red;">${errorText}</p>`;
                                }
                            }
                        })
                        .catch((error) => {
                            console.error("Error:", error);
                            const eventId = form.getAttribute("data-event-id");
                            const messageDiv = document.getElementById("message-" + eventId);
                            if (messageDiv) {
                                messageDiv.innerHTML = `<p style="color:red;">Server error. Please try again later.</p>`;
                            }
                        });
                });
            });
        });

    </script>
</body>

</html>